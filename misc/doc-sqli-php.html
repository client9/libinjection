{% extends "base.html" %}
{% block body %}
<h1>
<a name="libinjection-php-api" class="anchor" href="#libinjection-php-api"><span class="octicon octicon-link"></span></a>libinjection PHP API</h1>

<p>The libinjection PHP API provides full access to the functions
and data structions of the C API.  It's very low-level and not
very pretty, but it's also very easy to assemble higher level
functionality.</p>

<p><b>
Help wanted on packaging into a PEAR module and help with Mac OS X
</b></p>

<h2>
<a name="install-the-php-module" class="anchor" href="#install-the-php-module"><span class="octicon octicon-link"></span></a>Install the PHP module</h2>

<p>It should be as simple as:</p>

<pre><code>make
</code></pre>

<p>This produces a <code>libinjection.so</code> which can be installed with other
PHP extensions.</p>

<p>To load the module, add the following to your <code>php.ini</code> file:</p>

<pre><code>extension=/path/to/libinjection.so
</code></pre>

<p>Or you might be able to do:</p>

<pre><code>// note may not work with PHP CLI without other
// configuration changes
dl_open('/path/to/libinjection.so');
</code></pre>

<p>You can do a quick test with:</p>

<div class="highlight"><pre><span class="k">echo</span> <span class="nx">LIBINJECTION_VERSION</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div>

<h2>
<a name="using-libinjection" class="anchor" href="#using-libinjection"><span class="octicon octicon-link"></span></a>Using libinjection</h2>

<p>The basic flow is as follows:</p>

<div class="highlight"><pre>
<span class="c1">// create a state object using a special function</span>
<span class="c1">// one does not use the 'new operator'</span>
<span class="c1">// this object can be reused.</span>
<span class="nv">$ss</span> <span class="o">=</span> <span class="nx">new_libinjection_sqli_state</span><span class="p">();</span>

<span class="c1">// one URL-decodes the input</span>
<span class="c1">// validates and normalizes the UTF-8</span>
<span class="nv">$arg</span> <span class="o">=</span> <span class="s2">"1 union select 1,2,3,4 --"</span><span class="p">;</span>

<span class="c1">// always 0 for now</span>
<span class="nv">$flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">//</span>
<span class="c1">// Prepare to do work</span>
<span class="c1">//</span>
<span class="nx">libinjection_sqli_init</span><span class="p">(</span><span class="nv">$ss</span><span class="p">,</span> <span class="nv">$arg</span><span class="p">,</span> <span class="nv">$flags</span><span class="p">);</span>

<span class="c1">//</span>
<span class="c1">// now check if SQLi</span>
<span class="c1">// returns</span>
<span class="c1">//   0 == safe input</span>
<span class="c1">//   1 == is sqli</span>
<span class="nv">$issqli</span> <span class="o">=</span> <span class="nx">libinjection_is_sqli</span><span class="p">(</span><span class="nv">$ss</span><span class="p">);</span>

<span class="nv">$fingerprint</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$sqli</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$fingerprint</span> <span class="o">=</span> <span class="nx">libinjection_sqli_state_fingerprint_get</span><span class="p">(</span><span class="nv">$x</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// do something</span>

</pre></div>

<p>This flow can be wrapped into a simple class:</p>

<pre><code>
class libinjection {
  public $_cPtr=null;

  function __construct() {
     $this-&gt;_cPtr = new_libinjection_sqli_state();
  }
  function is_sqli($arg) {
     libinjection_sqli_init($this-&gt;_cPtr, $arg, 0);
     $issqli = libinjection_is_sqli($this-&gt;_cPtr);

     $fingerprint = '';
     if ($sqli == 1) {
         $fingerprint = libinjection_sqli_state_fingerprint_get($this-&gt;_cPtr);
     }
     return $fingerprint;
  }
};

$check = new libinjection();

$fingerprint = $check-&gt;is_sqli("1 union select 2 --");
if ($fingerprint) {
  // it's sqli, do something
}
</code></pre>

<h2>
<a name="using-libinjection-data-structures" class="anchor" href="#using-libinjection-data-structures"><span class="octicon octicon-link"></span></a>Using libinjection data structures</h2>

<p>The API to the data structure fields isn't pretty but it is easy.
Everything is in the form of <code>datastructurename-field-get</code>.  For
example <code>libinjection_sqli_state_slen_get</code> or
<code>libinjection_sqli_token_type_get</code>.</p>

<p>This is one exception, that is the <code>tokenvec</code> in
<code>libinjection_sqli_state</code>.  The <code>swig</code> doesn't appear to understand
static C arrays.  To access elements, use
<code>libinjection_sqli_state_tokenvec_geti</code> and pass in the state object,
and an index value (integer).</p>

<p>All the data structures are also read-only.</p>{% end %}
